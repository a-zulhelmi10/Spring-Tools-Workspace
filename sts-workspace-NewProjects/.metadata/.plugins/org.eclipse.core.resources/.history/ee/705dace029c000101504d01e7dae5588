package com.camdrilee.service;

import java.sql.Timestamp;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.server.ResponseStatusException;

import com.camdrilee.entity.CategoryEntity;
import com.camdrilee.io.CategoryRequest;
import com.camdrilee.io.CategoryResponse;
import com.camdrilee.repository.CategoryRepository;
import com.fasterxml.jackson.databind.ObjectMapper;

import jakarta.persistence.Column;

@Service
public class CategoryService {
	
	//apply CRUD methods
	@Autowired
	private CategoryRepository categoryRepository;
	@Autowired
	private FileUploadService fileUploadService;
	
	//add category
	public CategoryResponse addCategory(CategoryRequest catReq, MultipartFile file){
		CategoryEntity newCat= new CategoryEntity(); 
		newCat = convertToEntity(catReq);
		String imgUrl = fileUploadService.uploadFile(file);
		newCat.setImgUrl(imgUrl);
		categoryRepository.save(newCat);
		return convertToResponse(newCat);
	}
	
	public void deleteCategory(String catId) {
		CategoryEntity existingCat = categoryRepository.findByCatId(catId).orElseThrow(
				()->new ResponseStatusException(HttpStatus.NOT_FOUND,"Category not found"));
		categoryRepository.delete(existingCat);
	}
	public List<CategoryResponse> listCategories() {
		return categoryRepository.findAll().stream()
				.map(CategoryEntity -> convertToResponse(CategoryEntity))
				.collect(Collectors.toList());
	}
	

	private CategoryResponse convertToResponse(CategoryEntity newCat) {
		return CategoryResponse.builder()
			.imgUrl(newCat.getImgUrl())
			.bgColor(newCat.getBgColor())
			.catId(newCat.getCatId())
			.catName(newCat.getCatName())
			.location(newCat.getLocation())
			.createdAt(newCat.getCreatedAt())
			.updatedAt(newCat.getUpdatedAt())
			.build();
	}

	private CategoryEntity convertToEntity(CategoryRequest catReq) {
		return CategoryEntity.builder()
			.catId(UUID.randomUUID().toString())
			.catName(catReq.getName())
			.location(catReq.getLocation())
			.bgColor(catReq.getBgColor())
			.build();
	}
	
	}

